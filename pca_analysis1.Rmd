---
title: "Raisin Dataset PCA Analysis"
author: "Data Analyst"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 6)
```

# Introduction

**YouTube Tutorial:** [https://www.youtube.com/watch?v=gSnXIzhAQms&ab_channel=RajendraChoure](https://www.youtube.com/watch?v=gSnXIzhAQms&ab_channel=RajendraChoure)

This analysis demonstrates Principal Component Analysis (PCA) on a raisin dataset to reduce dimensionality while maintaining classification performance.

# Load Required Libraries

```{r}
library(readxl)      # For reading Excel files (.xlsx, .xls) into R
library(tidyverse)   # Collection of data manipulation and visualization packages (dplyr, ggplot2, etc.)
library(ggfortify)   # Extends ggplot2 to easily plot statistical models like PCA, clustering results
library(factoextra)  # Specialized functions for extracting and visualizing multivariate analysis results
library(ggExtra)     # Adds marginal plots (histograms, density plots) to ggplot2 scatter plots
library(corrplot)    # Creates visually appealing correlation matrix plots and heatmaps
library(gridExtra)   # Arranges multiple ggplot objects into grid layouts for combined displays
library(caret)
```

# Data Loading and Exploration

```{r}
raisin_data <- read_csv("Raisin_Dataset.csv")
head(raisin_data)
str(raisin_data)
```

```{r}
summary(raisin_data)
```

# Data Visualization - Density Plots

## Base R Method

```{r}
par(mfrow = c(1,2))  # Base R graphics function - sets up plotting layout to display 2 plots side by side in 1 row

features <- colnames(raisin_data[,-8])

for (feature in features) {
  # plot density for the current plot
  plot(density(raisin_data[[feature]]),
     main = paste("Density plot of ", feature),
     xlab = feature,
     ylab = "density"
     )
  # OPtional : add rug plot to show individual data points.
  rug(raisin_data[[feature]])
  
}
```

## ggplot2 Method

```{r}
################ ggplot method to above for loop ######################

# Create a list to store all plots
plot_list <- list()                              # Initialize empty list to store individual ggplot objects


for (feature in features) {                     # Loops through each feature to create individual density plots
  # Create ggplot density plot for the current feature
  p <- ggplot(raisin_data, aes_string(x = feature)) +           # Creates ggplot object with current feature on x-axis
    geom_density(fill = "lightblue", alpha = 0.7, color = "blue") +  # Adds density curve with blue fill and border
    geom_rug(alpha = 0.5) +                                     # Adds rug plot showing individual data point locations
    labs(title = paste("Density plot of", feature),             # Sets plot title with feature name
         x = feature,                                            # Labels x-axis with feature name
         y = "Density") +                                        # Labels y-axis as "Density"
    theme_minimal()                                              # Applies clean, minimal theme for better appearance
  
  plot_list[[feature]] <- p                                                         # Explicitly prints the plot (required in loops)
}

# Arrange all plots in a grid layout
do.call(grid.arrange, c(plot_list, ncol = 3))   # Uses do.call to pass the list of plots correctly to grid.arrange
```

# Correlation Analysis

```{r}
corrplot(cor(raisin_data[,-8]))
```

# Missing Value Analysis

```{r}
# check for NA
colSums(is.na(raisin_data))
# we can see no missing values in the data.

# alternative approach to missing value checking
library(VIM)                    # Visualization and Imputation of Missing values - package for analyzing missing data patterns
aggr(raisin_data)              # Creates a visual summary showing missing value patterns across all variables in the dataset
str(raisin_data)
```

# Data Preprocessing

```{r}
# Clean and prepare data
raisin_clean <- raisin_data %>%
  mutate(Class = as.factor(Class))     # Converts the 'Class' variable from character/numeric to a factor (categorical variable)
# This is important for classification tasks and ensures proper handling in statistical models

str(raisin_clean)

# split features and target
features <- raisin_clean %>%
  select(-Class)
str(features)
target <- raisin_clean$Class

# Scale features
features_scaled <- scale(features)
summary(features_scaled)
```

# Principal Component Analysis (PCA)

```{r}
# perform PCA
pca_result <- prcomp(features_scaled, scale. = TRUE) # since we used scale. = TRUE, we don't need to do the above step to standardization.
pca_result 

# 1. Basic PCA summary
pca_summary <- summary(pca_result)
pca_summary
# we can see first 3 components are sufficient to explain the data.
```

# Detailed Correlation Analysis

```{r}
# 2. correlation analysis
par(mfrow = c(1,1))
correlation_matrix <- cor(features)
corrplot(correlation_matrix , method = "color",
         type = "upper",
         addCoef.col = "black",
         tl.col = "black",
         tl.srt = 45)
```

# PCA Visualizations

```{r}
# Analyze the PCA results
# 1. Scree plot
scree_plot <- fviz_eig(pca_result,
                       addlabels = TRUE,
                       ylim = c(0, 100),
                       main = "Scree plot: variance explained by principal components") +
  theme_minimal()

scree_plot
```

```{r}
# 2. PCA biplot with a confidence ellipse
biplot <- fviz_pca_ind(pca_result,
                       col.ind = target,
                       addEllipses = TRUE,
                       ellipse.level = 0.95,
                       legend.title = "Class",
                       title = "PCA biplot with Confidence Ellipse") +
                       scale_color_brewer(palette = "Set1")
biplot
```

```{r}
# 3. variable contribution plot
var_contrib <- fviz_contrib(pca_result,
                            choice = "var",
                            axes = 1:2,
                            top = 10,
                            title = "Variable contributions to PC1 and PC2")
var_contrib
```

```{r}
# 4. variable correlation circle
var_cor <- fviz_pca_var(pca_result,
                        col.var = "contrib",
                        gradient.cols = c("blue", "yellow", "orange"),
                        repel = TRUE,
                        title = "Variable correlation circle")
var_cor
```

```{r}
# 5. Quality of representation (cos2)
var_cos2 <- fviz_cos2(pca_result,
                      choice = "var",
                      axes = 1:2,
                      title = "Quality of Representation on PC1 and PC2")
var_cos2
```

```{r}
# Arrange and save plots
combined_plots <- grid.arrange(scree_plot,biplot, var_contrib, var_cor,
                               ncol = 2, nrow = 2,
                               top = "PCA analysis visualization")
```

# Predictive Modeling

## Model using Original Data

```{r}
## predictive modeling ##
# model using the original data

model <- glm(Class ~ ., data  = raisin_clean, family = binomial())
predictions <- predict(model, raisin_clean, type = "response")
predicted_classes <- ifelse(predictions > 0.5, "Kecimen", "Besni")

confusion_matrix_ori <- confusionMatrix(as.factor(predicted_classes), as.factor(raisin_clean$Class))
confusion_matrix_ori
```

## Model using PCA Results

```{r}
# model using the pca results

# extract scores
scores <- as.data.frame(pca_result$x[, 1:3])

scores$Class <- target
str(scores)

# train model
model1 <- glm(Class ~ ., data = scores, family = binomial())

# make prediction
predictions <- predict(model1, scores, type = "response")
predicted_classes <- ifelse(predictions > 0.5, levels(target)[2], levels(target)[1])

# evaluate model
confusion_matrix_pca <- confusionMatrix(as.factor(predicted_classes), as.factor(scores$Class))

confusion_matrix_ori$overall[1]
confusion_matrix_pca$overall[1]
```

# Additional Visualizations

```{r}
# Plot using ggplot2 with labels and confidence ellipses
ggplot(raisin_data, aes(x = MajorAxisLength, y = MinorAxisLength, color = Class, label = rownames(raisin_data))) +
  geom_point(size = 2, alpha = 0.7) +  # Scatter plot for each point
  geom_text(vjust = -0.5, hjust = 0.5, size = 3) +  # Add labels (point indices)
  stat_ellipse(aes(fill = Class), geom = "polygon", alpha = 0.2, level = 0.95) +  # Confidence ellipses
  scale_color_brewer(palette = "Set1") +  # Color scheme similar to PCA plot
  labs(title = "Scatter Plot of Original Variables with Point Labels and Confidence Ellipses",
       x = "Major Axis Length",
       y = "Minor Axis Length",
       color = "Class") +
  theme_minimal()

# Create a biplot showing both principal components and the data points
fviz_pca_biplot(pca_result, 
                geom.ind = "point",   # Show points only (no text labels for data points)
                geom.var = "arrow",   # Show principal component vectors as arrows
                col.ind = raisin_data$Class,  # Color by class (or target variable)
                palette = "Set1",     # Color palette for class groups
                addEllipses = TRUE,   # Add confidence ellipses
                ellipse.level = 0.95, # Confidence level
                legend.title = "Class", 
                arrowsize = 1.5 ) +
  labs(title = "PCA Biplot with Data Points and Principal Components",
       x = "PC1", y = "PC2") +
  theme_minimal()
```